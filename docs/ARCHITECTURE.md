# GMOコイン デイトレードシステム - アーキテクチャ設計書

## 1. システム概要

### 1.1 目的
GMOコインAPIを使用した暗号資産の自動デイトレードシステム。
ペアトレード戦略とトレンドフォロー戦略を組み合わせ、リスク管理を徹底した運用を行う。

### 1.2 主要機能
- **自動売買**: ペアトレード（50%）+ トレンドフォロー（50%）
- **バックテスト**: 過去データによる戦略検証
- **ウォークフォワード分析**: 定期的な戦略最適化
- **リアルタイム監視**: ダッシュボードによる状況把握
- **リスク管理**: 厳密な損失制限とポジション管理

---

## 2. システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          VPS Environment                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │   Dashboard  │    │  Scheduler   │    │   Alerting   │              │
│  │  (Streamlit) │    │  (APScheduler)│   │  (Telegram)  │              │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘              │
│         │                   │                   │                       │
│  ┌──────┴───────────────────┴───────────────────┴───────┐              │
│  │                    Core Engine                        │              │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │              │
│  │  │   Strategy  │  │    Risk     │  │  Execution  │  │              │
│  │  │   Engine    │  │  Manager    │  │   Engine    │  │              │
│  │  │             │  │             │  │             │  │              │
│  │  │ - Pair      │  │ - Position  │  │ - Order     │  │              │
│  │  │ - Trend     │  │ - Stop Loss │  │ - Cancel    │  │              │
│  │  │ - Signal    │  │ - Exposure  │  │ - Modify    │  │              │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │              │
│  └──────────────────────────┬────────────────────────────┘              │
│                             │                                           │
│  ┌──────────────────────────┴────────────────────────────┐              │
│  │                   Data Layer                           │              │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │              │
│  │  │  Market     │  │  Position   │  │  Historical │   │              │
│  │  │  Data       │  │  Data       │  │  Data       │   │              │
│  │  │  (Redis)    │  │  (Postgres) │  │  (Postgres) │   │              │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │              │
│  └──────────────────────────┬────────────────────────────┘              │
│                             │                                           │
│  ┌──────────────────────────┴────────────────────────────┐              │
│  │              GMO Coin API Connector                    │              │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │              │
│  │  │  Public API │  │ Private API │  │  WebSocket  │   │              │
│  │  │  (価格取得)  │  │ (注文・残高) │  │  (リアルタイム)│   │              │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │              │
│  └───────────────────────────────────────────────────────┘              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                         ┌──────────────────┐
                         │   GMO Coin API   │
                         │    (External)    │
                         └──────────────────┘
```

---

## 3. コンポーネント詳細

### 3.1 GMO Coin API Connector

| 機能 | API種別 | 用途 |
|------|---------|------|
| 価格取得 | Public REST | 現在価格、板情報 |
| OHLCV取得 | Public REST | ローソク足データ |
| 残高照会 | Private REST | 資産状況確認 |
| 注文発行 | Private REST | 売買注文 |
| 注文照会 | Private REST | 注文状況確認 |
| リアルタイム価格 | WebSocket | ティックデータ |

### 3.2 Strategy Engine

#### 3.2.1 ペアトレード戦略（資金50%）
```
目的: 相関の高い通貨ペア間の価格乖離を利用した市場中立戦略

手法:
1. 相関分析 - 過去N日間の相関係数を計算
2. コインテグレーション検定 - 長期的な均衡関係の確認
3. スプレッド計算 - Z-Score による乖離度測定
4. エントリー - Z-Score が閾値を超えた時点
5. エグジット - Z-Score が平均回帰した時点

候補ペア例:
- BTC/ETH
- ETH/LTC
- XRP/XLM
```

#### 3.2.2 トレンドフォロー戦略（資金50%）
```
目的: 明確なトレンドに追従して利益を獲得

手法（複数指標の組み合わせ）:
1. 移動平均クロスオーバー (EMA 9/21/55)
2. RSI (14) - 過熱感の確認
3. MACD - トレンド強度の確認
4. ATR - ボラティリティベースのストップロス
5. ボリュームプロファイル - 出来高確認

エントリー条件:
- 短期EMA > 中期EMA > 長期EMA（ロング）
- RSI 30-70 の範囲内
- MACD ヒストグラムがシグナル方向
```

### 3.3 Risk Manager

```python
# リスクパラメータ例
RISK_PARAMS = {
    # ポジションリスク
    "max_position_size_pct": 0.05,      # 1ポジションあたり最大5%
    "max_total_exposure_pct": 0.30,     # 総エクスポージャー最大30%

    # 損失制限
    "max_daily_loss_pct": 0.02,         # 1日最大損失2%
    "max_weekly_loss_pct": 0.05,        # 週間最大損失5%
    "max_monthly_loss_pct": 0.10,       # 月間最大損失10%

    # 個別ポジション
    "stop_loss_pct": 0.02,              # ストップロス2%
    "take_profit_pct": 0.04,            # テイクプロフィット4%
    "trailing_stop_pct": 0.015,         # トレーリングストップ1.5%

    # 相関リスク
    "max_correlated_positions": 3,       # 相関ポジション最大3
}
```

### 3.4 Execution Engine

```
注文フロー:
1. シグナル受信 → リスクチェック
2. 注文サイズ計算（ケリー基準 or 固定比率）
3. スリッページ考慮した指値設定
4. 注文送信 → 確認待ち
5. 部分約定処理 / リトライロジック
6. ポジション更新 → ログ記録
```

### 3.5 Backtest & Walk-Forward

```
バックテストフロー:
1. 過去データ取得（1年分以上推奨）
2. 戦略パラメータでシミュレーション
3. パフォーマンス指標計算
   - シャープレシオ
   - 最大ドローダウン
   - 勝率・プロフィットファクター
   - カルマーレシオ

ウォークフォワード:
1. データを訓練期間とテスト期間に分割
2. 訓練期間でパラメータ最適化
3. テスト期間で検証
4. ウィンドウをスライドして繰り返し
5. 週次で自動実行（日曜日深夜）
```

### 3.6 Dashboard

```
表示項目:
- リアルタイム損益（PnL）
- ポジション一覧
- 注文履歴
- 戦略別パフォーマンス
- リスク指標（現在のエクスポージャー等）
- システムヘルスチェック
- アラート履歴
```

---

## 4. データフロー

```
[GMO API] → [WebSocket/REST] → [Redis Cache] → [Strategy Engine]
                                     │
                                     ▼
                              [PostgreSQL]
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
              [Backtest]      [Dashboard]      [Walk-Forward]
```

---

## 5. 計算資源要件

### 5.1 VPS推奨スペック

| 用途 | 最小スペック | 推奨スペック |
|------|-------------|-------------|
| CPU | 2 vCPU | 4 vCPU |
| RAM | 4 GB | 8 GB |
| Storage | 50 GB SSD | 100 GB SSD |
| Network | 100 Mbps | 1 Gbps |

### 5.2 計算負荷の見積もり

```
常時稼働プロセス:
- WebSocket接続維持: 低負荷
- 価格データ処理: 低〜中負荷
- 戦略計算（1分足）: 中負荷
- リスク計算: 低負荷

定期実行（高負荷）:
- バックテスト: 高負荷（10-30分/回）
- ウォークフォワード: 高負荷（1-2時間/週）
- 相関分析更新: 中負荷（5分/回）

→ 通常運用は2vCPU/4GBで十分
→ バックテスト時は一時的に負荷増大
→ 推奨: 4vCPU/8GB で余裕を持った運用
```

---

## 6. セキュリティ設計

### 6.1 API認証情報
```
- 環境変数で管理（.env）
- .gitignore に追加
- 本番環境では Secret Manager 使用推奨
```

### 6.2 ネットワーク
```
- VPS のファイアウォール設定
- SSH キー認証のみ
- ダッシュボードは認証必須
- API通信はHTTPS/WSS
```

### 6.3 監査ログ
```
- 全注文のログ記録
- 戦略判断のログ記録
- エラー・例外のログ記録
- ログローテーション設定
```

---

## 7. 障害対策

### 7.1 自動復旧
```
- プロセス監視（systemd / supervisor）
- WebSocket再接続ロジック
- API障害時のリトライ
```

### 7.2 緊急停止
```
- 手動緊急停止ボタン（ダッシュボード）
- 自動停止条件:
  - 日次損失上限到達
  - API連続エラー
  - 異常な価格変動検知
```

### 7.3 バックアップ
```
- データベース日次バックアップ
- 設定ファイルのバージョン管理
- ポジション状態の永続化
```
